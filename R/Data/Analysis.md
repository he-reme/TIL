# 상관분석과 회귀분석

#### 전통적인 통계분석

* 모수를 추정하기 위해 샘플링하고 추정하는 작업
* 주로 **추론 분석**을 진행

#### 빅데이터 통계분석

* 이미 모수를 가지고 있음. 
* 데이터 안에 숨겨진 패턴, 규칙을 찾아서 원하는 분석 결과를 도출
* 데이터를 파악하려는 단계에서(EDA)에서 **기술 통계 분석**을 진행

### 분석

> 상관 관계가 있어야 회귀 분석에 대해 의미가 있음

#### 상관관계분석

* Correlation Analysis
* 두 변수간의 **선형관계**를 조사하는 것

#### 단순회귀분석

* Simple regression analysis
* 두 변수간의 **인과관계**를 조사하는 방법

#### 다중회귀분석

* Multiple regression analysis
* 두 개 이상의 독립변수들과 하나의 종속변수의 **인과관계**를 분석한느 기법
* 단순회귀분석을 확장한 것

---



## 기술 통계

* 데이터의 특성을 이해하기 쉽게 기술하는 통계

* 수집한 데이터 정리, 그래프나 숫자 등으로 요약, 표현하는 등 데이터의 특성을 규명하는 통계적 방법
* 평균, 중앙값, 최빈값, 범위, 분산, 표준편차, 사분위수, 도수분포표, 왜도, 첨도 등을 활용



---



## 상관 분석

* 두 변수 간에 어떤 선형적 또는 비선형적 관계를 갖고 있는지 분석하는 방법

* 두 변수는 서로 독립적인 관계이거나 상관된 관계일 수 있음
  * 이때 두 변수 간의 관계의 강도를 **상관계수** 라고 함

#### 상관계수

* 상관관계의 정도를 파악
* 두 변수의 연관 정도만을 나타냄

#### 피어슨 상관계수

* 두 연속성 변수간의 선형적인 관계를 측정
* `-1`과 `1` 사이의 값을 가짐
* `-1` 또는 `1`에 가까울수록 뚜렷한 선형적인 상관관계를 가짐
* **산점도**를 그려서 두 변수간의 상관관계를 시각적으로 파악 가능
* `[X변수와 Y변수의 상관계수] = [X와 Y의 공분산] / ([X의 표준편차] * [Y의 표준편차])`
  * X와 Y가 함께 변하는 정도를 X와 Y가 각각 변하는 정도로 나눔

* `cor(X, Y)`
  * R에서 지원하는 피어슨 상관계수를 계산하는 함수

#### `cor()`

````R
cor(X, method="상관관계종류")
````

* 상관계수 구하기
* X
  * 벡터
  * 매트릭스
  * 데이터 프레임
* 상관관계 종류
  * `pearson`
    * 기본값
  * `kendall`
    * 두 변수에 대한 비선형 관계의 연관성을 파악
    * 데이터가 서열 척도인 경우 (값 대신 순위를 이용하는 경우) 사용됨
    * 데이터의 갯수가 적을 때, 데이터의 동률이 많을 때 유용
  * `spearman`
    * 두 변수에 대한 비선형 관계의 연관성을 파악
    * 데이터가 서열 척도인 경우 (값 대신 순위를 이용하는 경우) 사용됨
    * 일반적으로 켄달 상관계수보다 높은 값을 가짐
* 여러 변수에 대해 상관계수를 구하려는 경우
  * `corrplot()` 혹은 `corrgram()` 등의 함수 이용해서 시각화 하는 방법이 더욱 효과적

#### `cor.test()`

* 상관계수 검정

* 상관계수의 통계적 유의성 (통계적으로 의미가 있는지) 검증
* 가설
  * 대립가설
    * 상관계수는 0 이 아니다
    * 주장하려는 가설
    * 새로운 가설을 의미
    * 
  * 귀무가설
    * 상관계수는 0 이다
    * 대립가설의 반대 가설
    * 통상적으로 인정되는 일반적인 가설을 의미

* 두 가설을 모두 검증하는 것이 아니라 기존가설(귀무가설)이 잘못됐다는 것을 증명함으로써 
* 새로운 가설(대립가설)을 채택하는 방식 사용
* 이 때 사용되는 지표 중 하나 : `p-value` (유의확률)
* `p-value`
  * 유의확률
  * 귀무가설이 참이라는 가정하에 얻은 통계량이 귀무가설을 얼마나 지지하는지를 나타낸 확률
    * 단지 주어진 분석에 대해서 귀무가설이 통계적으로 의미가 있는지 여부를 판단하는 기준
  * 일반적으로 `0.05` 
    * 이하이면 귀무가설을 기각
    * 이상이면 귀무가설을 채택
  * `p-value` 값이 적을수록 대립가설이 통계적 의미를 가짐



---



## 선형회귀분석

* 종속변수 Y와 한 개 이상의 독립변수(설명변수) X와의 관계를 모델링하는 회귀분석 기법

* **단순선형회귀**
  * 한 개의 설명변수에 기반한 경우
  * 하나의 독립변수와 하나의 종속변수 간의 회귀 분석
* **다중선형회귀**
  * 두 개 이상의 설명변수에 기반한 경우
  * 독립변수가 여러개인 경우
* 종속변수
  * 반응변수, 관심변수
  * 영향을 받는 변수
* 독립변수
  * 설명변수
  * 영향을 주는 변수

#### 선형회귀 모델

* 추세선을 이용하여 **종속변수의 값을 예측**하는 모델
* 결정계수
  * 추정한 선형 모델이 주어진 데이터에 적합한 정도를 재는 척도
* `lm()`
  * 선형회귀 모델 생성
* `residuals()`
  * 잔차 확인
* `predict.lm()`, `predict()`
  * 종속변수 데이터를 예측
* `summary()`
  * 결정계수, 수정된 결정계수 및 F 통계량, 잔차, 사분위수, 회귀계수를 확인
  * `Residuals` : 잔차 정보
* `ceof()`
  * 회귀계수만 출력



---



### 단순선형회귀

* 하나의 독립변수와 하나의 종속변수 간의 회귀 분석
* **단순회귀분석의 가장 기본적인 과업** : 2개의 계수를 구하는 것
  * 각 계수들을 구해야 식을 완성하고, 독립변수를 입력했을 때 종속변수를 예측할 수 있는 것임
* 독립변수 (예측변수)
  * 영향을 미칠 것으로 생각되는 변수
* 종속변수 (기준변수)
  * 영향을 받을 것으로 생각되는 변수
  * 우리가 구하고 싶은 값
* 전제조건
  * 독립변수와 종속변수의 설정은 논리적 타당성을 토대로 해야함

#### 설명

* 독립변수에 대한 종속변수 값들을 이용하여 
* 두 변수간의 선형 관계를 설명하는 **회기선**인 직선의 방정식 ( y=a+bx )를 만들고 
* 임의의 x값에 대한 y값의 추정치를 추론하는 방법
* 이 때 회귀선은 x에 대응하는 실제 y값과 추정된 y값 사이의 오차인 **잔차**를 최소화하는 직선을 잘 정해야 설명력이 좋은 회귀 방정식이 됨

#### 회귀선을 찾는 방법

* 범위 탐색
* 통계적 방법
  * 일반적으로 많이 사용됨
  * 잔차들의 제곱합을 최소화하는 최소 제곱법 이용
  * `abline()`
* 머신러닝 방법
  * 경사하강법 이용

#### 사용

* 선형회귀모델 만들기 (회귀식 만들기)

  ```R
  model <- lm(종속변수~독립변수, data=df)
  model <- lm(df$종속변수~df$독립변수)
  ```
  * 종속변수 : 결과
  * 독립변수 : 원인

* 예측하기

  ```R
  predict.lm(model, newdata=data.frame(독립변수=값))
  predict(model, newdata=data.frame(독립변수=값))
  fitted(model)
  ```

* 단순회귀 모델의 시각화

  ```R
  plot(df$독립변수, df$종속변수) # 그래프 그리고
  abline(coef(model)) # 회귀선 그리기
  ```

* 결정계수 확인하기

  ```R
  summary(model)
  ```

  * 결정계수
    * R-squared (R^2)
    * 추정한 선형모델이 주어진 데이터에 적합한 정도를 재는 척도
    * 전체 분산값(SST)과 설명되는 분산값(SSR)로 계산
  * `0`~ `1` 값을 가짐
    * `1` 에 가까울수록 설명력이 좋은 모델

* 회귀 계수 출력

  ```R
  coef(model)
  ```

* 잔차 구하기

  ```R
  residuals(model)
  ```

  

#### 예시

```R
# R에 내장된 women 데이터셋으로 키에 따른 몸무게 예측 분석
View(women)

# 선형관계 확인
plot(women, xlab="키(in)", ylab="몸무게(lbs)")

# 회귀선 그리기
plot(women$height, women$weight, xlab="키(in)", ylab="몸무게(lbs)")
abline(lm(weight~height, data=women), col="red", lty=2)

cor(women$height, women$weight) 

# 회귀분석
# intercept정보 : 회귀선의 y절편
# 독립변수 정보
women.lm <- lm(weight~height, data=women)
women.lm # intercept 정보(회귀선의 y절편), 독립변수 정보
str(women.lm)

# Residuals : 잔차 정보
# Multiple R-squared : 회기식의 적합도 확인 (설명력)
# Adjustd R-squared : 수정된 Rsquared (다중선형회귀에서만 사용)
# p-value : 설명력의 유효성 확인
# Estimate std 를 통해 방정식 확인 가능 (predict() 함수 사용하면 이것이 바로 적용됨)
summary(women.lm)

# 회귀식(모델)
# wight = -87.51667 + 3.45000*height
# 키값에 따른 몸무게 예측
h = c(100, 120, 140)
-87.51667 + 3.45000*h

predict(women.lm, data.frame(height=h))
```





---



### 다중선형회귀

* 하나의 종속변수(Y)와 두 개 이상의 독립변수(X)가 있고 오차항이 있는 선형 관계
* 단순회귀분석을 확장한 것
* 다중회귀분석의 가장 기본적인 과업 : 각 계수들을 구하는 것
  * 각 계수들을 구해야 식을 완성하고, input에 대해 예측할 수 있는 것임
* 독립변수 (예측변수)
  * 영향을 미칠 것으로 생각되는 변수
* 종속변수 (기준변수)
  * 영향을 받을 것으로 생각되는 변수
  * 우리가 구하고싶은 값

* **표준화**
  * 독립변수가 여러 개여서 단위가 맞지 않는 경우 표준화 먼저 해주고 예측값을 구함
  * 원래의 변수측정치를 평균이 0이고 분산이 1인 새로운 변수로 변화시키는 과정
  * 표준화 하는 방법
    * 변수에서 그 변수의 평균을 차감한 후, 이 값을 그 변수의 표준편차로 나누면 됨
    * `scale()`

#### 설명 변수의 선택법

* 종속변수에 영향을 주는 독립 변수를 선택하는 방법

* `AIC`가 가장 적은 독립 변수 셋 찾기

* 선택하는 이유
  * 독립변수 모두를 회귀 모형에 포함하는 경우, 
  * 독립변수들 중 일부만을 포함하는 회귀모형에 비해서 결정계수의 값이 항상 크므로 설명력을 최대화시킬 수 있는 반면에
  * 독립변수들간의 상관관계가 커져서 생기는 **다중공신성**의 문제에 직면하는 경우가 많고, 
  * 따라서 모형의 안정성과 신뢰성에 의문이 생길 수 있음

* 다중공신성
  
  * 여러 독립변수사이의 관계가 너무 밀집되어 있어(상관관계가 높아) 회귀분석시 결과가 제대로 나오지 않는 것
  * 다중 선형 회귀에서 독립변수들간에 강한 선형관계가 있을 때.
  * 잘못된 변수해석, 예측, 정확도 하락 등을 야기시킴.
* 의심이 가는 독립변수만을 가지고 회귀분석을 한 다음 `vif()` 함수로 분산팽창 계수를 확인한다.
    * 10이 넘는 변수는 다중공신성이 존재한다고 간주
  
* `step(model, direction="설명변수선택법")`
  * 전진 선택법 : `forward`
    * 한 개씩 늘려서 확인
  * 후진 선택법 : `backward`
    * 전체에서 한 개씩 줄이면서 확인
  * 단계적 방법 : `both`
    * 전진 추가법 + 후진제거법
    * 전진과 후진 중 해당 데이터셋에 맞는 것으로 자동 실행

* `AIC()`

  

#### 예시1

```R
# 엄마와 아빠 키로 아들의 키를 예측하는 다중선형회귀모델 생성 

height_father <- c(180, 172, 150, 180, 177, 160, 170, 165, 179, 159) # 아버지 키 
height_mohter <- c(160, 164, 166, 188, 160, 160, 171, 158, 169, 159) # 어머니 키
height_son <- c(180, 173, 163, 184, 165, 165, 175, 168, 179, 160) # 아들 키 
height <- data.frame(height_father, height_mohter, height_son)
head(height) 

model <-lm (height_son ~ height_father + height_mohter, data = height)
model 

(coef_r <- coef(model))
coef_r[1]
coef_r[2]
coef_r[3]

# 잔차 
r <- residuals(model)
r[1:4]

# 예측 
predict.lm(model, newdata = data.frame(height_father = 170, height_mohter = 160))
predict.lm(model, newdata = data.frame(height_father = 170, height_mohter = 160), interval = "confidence")

# 결정계수와 수정된 결정계수
summary(model)
```

```R
Coefficients:
              Estimate Std. Error t value Pr(>|t|)   
(Intercept)    21.7437    28.7417   0.757  0.47402   
height_father   0.5027     0.1420   3.540  0.00947 **
height_mohter   0.3891     0.1628   2.390  0.04815 * 
```

#### 예시2

* 문제

  ```
  다중 회귀 분석을 사용해서 정수기 대수를 기준으로 추후에 소요될 AS 시간을 예측하고, AS 기사를 몇 명 고용할지 산출
  ```

* 가정

  * 총 대여수는 `300,000`대, 이 중 10년 이상 노후된 정수기는 `70,000`대로 가정
  * 기사 한 명이 한달간 처리하는 AS 시간은 `8시간 * 20일`

  

* 조건

  * `purifier.csv` 파일 사용
  * 변수
    * `purifier` : 전월 정수기 총 대여수
    * `old_purifier` : 전월 10년 이상 노후 정수기 총 대여수
    * `as_time` : 당월 AS 소요 시간
  * `독립변수` : 전월 기준 10년 미만 정수기 대여수, 전월 기준 10년 이상 정수기 대여수
  * `종속변수` : 당월 기준 AS에 소요된 시간

* 코드

  ```R
  library(dplyr)
  
  data <- read.csv("data/purifier.csv")
  View(data)
  
  # 10년 미만 정수기 대여 수 변수 추가
  data <- data %>% mutate(new_purifier = purifier - old_purifier)
  
  # 선형회귀모델 만들기 (회귀식 만들기)
  data.lm <-lm (as_time~new_purifier+old_purifier, data = data)
  
  # 추후에 소요될 AS 시간 예측
  predict_time <- predict(data.lm, 
                          data.frame(old_purifier=70000, new_purifier=300000-70000))
  
  # 추후에 AS 기사 고용 수 예측
  predict_hire <- predict_time/(8*20)
  
  # 예쁘게 출력
  cat(ceiling(predict_hire),"명", sep="")
  ```

  

