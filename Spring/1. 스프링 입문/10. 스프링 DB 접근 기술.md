# 10. 스프링 DB 접근 기술

> OS : Window

<br>

#### 목차

1. H2 데이터베이스
   * 사용한 데이터 베이스
2. 순수 JDBC
   * 옛날에는.. 이런식으로 데이터베이스 연동했다..
3. 스프링 통합 테스트
   * 스프링 어노테이션을 이용한 테스트 해보기
4. 스프링 JdbcTemplate
   * 현업에서는.. 이런식으로 데이터베이스 연동한다..
5. JPA
6. 스프링 데이터 JPA

<br>

---

<br>

## 1. H2 데이터베이스

> * 개발이나 테스트 용도로 가볍고 편리한 DB
>
> * 웹 화면 제공

<br>

#### 설치하기

* 설치한 버전 : 1.4.200
* 다운로드한 파일 : Platform-Independent.Zip
  * 그 후 적절한 폴더에 압축 풀기

* https://www.h2database.com/html/download-archive.html

<br>

#### 실행하기

* cmd 열기

* 압축 푼 폴더 접근

  * 명령어 : `cd C:\SpringStudy\study01\h2-2019-10-14\h2\bin`

* 실행하기

  * 명령어 : `h2.bat`

* 연결 전 화면

  ![H2 데이터베이스](https://user-images.githubusercontent.com/71495290/183645345-4fb4128d-986e-4d8d-b092-09b775c706ad.PNG)

* 연결 후 화면

  ![H2 실행화면](https://user-images.githubusercontent.com/71495290/183652409-e3985a9c-e75f-48c0-a529-9449018a1563.PNG)

* 참고

  * 만약 제대로 실행되지 않고 무한로딩일 경우 URL에서 아이피 지우고, 그 자리에 `localhost` 입력

<br>

#### 최초 접속 시

1. 연결하기

   * JDBC URL : `jdbc:h2:~/test`

   * 사용자명 : `sa`

   * 비밀번호 : 없음

   * `연결 버튼` 클릭

2. 데이터베이스 연결끊기

   * `맨 왼쪽 상단 버튼` 클릭

3. 데이터베이스 파일 생성 됐는 지 확인

   * home 디렉토리에 `test.mv.db` 파일이 있는지 확인
   * `dir` 명령어로 파일 목록 검색

<br>

#### 그 이후 접속 시

* JDBC URL을 `jdbc:h2:tcp://localhost/~/test`로 변경
* 변경하는 이유
  * JDBC URL이 `jdbc:h2:~/test`인 경우 파일로 직접 접근하는 방식이기 때문에
  * 애플리케이션과 웹콘솔이 동시에 접근하려고 할 때 충돌이 일어날 수 있음
  * 따라서 파일로 직접 접근하는 방식이 아닌, 패킷으로 접근하는 방식으로 변경한 것임.

<br>

#### SQL문 작성

* 테이블 생성하기

  ```sql
  drop table if exists member CASCADE;
  create table member
  (
  	id bigint generated by default as identity,
  	name varchar(255),
  	primary key (id)
  );
  ```

* 데이터 입력

  ```sql
  insert into member(name) values('spring')
  ```

<br>

#### 스프링 프로젝트에 데이터베이스 정보 입력

* `src > main > java > resources > application.properties`

  ```java
  spring.datasource.url=jdbc:h2:tcp://localhost/~/test
  spring.datasource.driver-class-name=org.h2.Driver
  spring.datasource.username=sa
  ```

<br>

---

<br>

## 2. 순수 JDBC

> 옛날에는.. 이런식으로 데이터베이스 연동했다..

<br>

---

<br>

## 3. 스프링 통합 테스트

> 단위 테스트가 베스트! 그러나 통합 테스트도 가끔 필요하니 알아두자~

#### 필요 어노테이션

* `@SpringBootTest`
  * 스프링 컨테이너와 테스트를 함께 실행함

* `@Transactional`

  * 테스트 케이스에 이 어노테이션이 있으면, 테스트 시작 전에 트랜잭션을 시작하고, 테스트 완료 후에 항상 롤백함. 

  * 이렇게 하면 DB에 데이터가 남지 않으므로 다음 테스트에 영향을 주지 않음!!

<br>

---

<br>

## 3. 스프링 JdbcTemplate

> 실무에서도 많이 씀!

* 순수 Jdbc와 동일한 환경설정 하면 됨
* 스프링 JdbcTemplate과 MyBatis 같은 라이브러리는 JDBC API에서 본 반복 코드를 대부분 제거해줌. 하지만 SQL은 직접 작성해야 함.

<br>

#### 사용 예시

```java
package hereme.hellospring.repository;

import hereme.hellospring.domain.Member;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.simple.SimpleJdbcInsert;

import javax.sql.DataSource;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

public class JdbcTemplateMemberRepository implements MemberRepository{

    private final JdbcTemplate jdbcTemplate;

    @Autowired
    public JdbcTemplateMemberRepository(DataSource dataSource) {
        jdbcTemplate = new JdbcTemplate(dataSource);
    }

    @Override
    public Member save(Member member) {
        SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
        jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");
        Map<String, Object> parameters = new HashMap<>();
        parameters.put("name", member.getName());
        Number key = jdbcInsert.executeAndReturnKey(new
                MapSqlParameterSource(parameters));
        member.setId(key.longValue());
        return member;
    }

    @Override
    public Optional<Member> findById(Long id) {
        List<Member> result = jdbcTemplate.query("select * from member where id = ?", memberRowMapper(), id);
        return result.stream().findAny();
    }

    @Override
    public Optional<Member> findByName(String name) {
        List<Member> result = jdbcTemplate.query("select * from member where name = ?", memberRowMapper(), name);
        return result.stream().findAny();
    }

    @Override
    public List<Member> findAll() {
        return jdbcTemplate.query("select * from member", memberRowMapper());
    }

    private RowMapper<Member> memberRowMapper() {
        return (rs, rowNum) -> {
            Member member = new Member();
            member.setId(rs.getLong("id"));
            member.setName(rs.getString("name"));
            return member;
        };
    }
}
```

